---
title: Configurar laboratorios para Análisis de Malware 
date: 2020-09-25 21:00:00 +0200
categories: [Tutorial,Malware]
tags: [Malware,Tutorial,Windows,Linux,VMware]
image:
  path: /assets/img/commons/malware-lab/malware.jpg
  width: 600
  height: 400
---

Para analizar un malware es necesario tener un entorno seguro con el que trabajar. Existen malwares tanto para Windows como Linux por lo que prepararemos ambos entornos. Para conseguirlo, hay que seguir a rajatabla los siguientes pasos:

## 1- Instalar una aplicación de virtualización

Para estar seguros a la hora de tratar con malwares, es imprescindible utilizar un software para virtualizar el entorno.

Hay muchos softwares distintos pero los más populares son:

<a href="https://www.virtualbox.org/wiki/Downloads">Oracle VM VirtualBox</a> que es **gratuito** y de **código abierto**.<br/>
<a href="https://www.vmware.com/es/products/workstation-pro/workstation-pro-evaluation.html">
VMware Workstation 16 Pro
</a> que es mucho más **ágil** y requiere **licencia**(tienes *30* días de prueba).

*Si vas a utilizar VMware deberás utilizar la versión Pro como la indicada arriba para poder realizar snapshots y **NO** la versión gratuita de VMware Player.*

## 2- Descargar la ISO de Windows y el OVA de Linux e instalarla

La ISO que debemos descargar es la de **Windows 10 Enterprise**.

<a href="https://www.microsoft.com/en-us/evalcenter/download-windows-10-enterprise">https://www.microsoft.com/en-us/evalcenter/download-windows-10-enterprise</a>

Nos descargamos la de 64 bits en el idioma que quieras, en mi caso elegí la de "English (United States)" para que sea más fácil a la hora de buscar por internet, si tenemos alguna duda.<br/>
Para instalarla añadimos una nueva maquina virtual en VMware, añadimos la ISO, le damos un espacio de mínimo *50GB* y seguimos el procedimiento de una instalación de Windows.

<br/>
Para Linux descargaremos **REMnux**

<a href="https://docs.remnux.org/install-distro/get-virtual-appliance">https://docs.remnux.org/install-distro/get-virtual-appliance</a>

Descargamos la General OVA si estamos en VMware y la VirtualBox OVA si estamos utilizando VirtualBox.
En la instalación tendremos que importar el OVA que hemos descargado y lo tendríamos.

## 3- Actualiza e instala las herramientas de análisis de malware

Lo primero de todo, en la máquina de **Windows** descargamos *Chrome* con Microsoft Edge. Después de haber hecho eso, añadimos una *snapshot* para tenerla de una fresca instalación sin nada más.

<br/>
![Foto FlareVM]({{ 'assets/img/commons/malware-lab/flarevm.jpg' | relative_url }}){: width="350" height="350" .center-image }
<br/>
Ahora para instalar FlareVM abriremos **Powershell como Administrador**, escribimos **Set-ExecutionPolicy Unrestricted** y seleccionamos **Yes to All**. Entonces escribimos 
```powershell
wget https://github.com/fireeye/flare-vm/raw/master/install.ps1 -UseBasicParsing -outfile C:\Users\"NOMBREUSUARIO"\Desktop\install.ps1
```
Vamos al escritorio y lo ejecutamos y esperamos como unos 40 minutos para que termine. Cuando termine, reiniciamos y ya tendríamos la herramienta preparada.

También deberíamos descargarnos **sysinternalsuite** ya que no viene todo con el FlareVM <a href="https://learn.microsoft.com/es-es/sysinternals/downloads/sysinternals-suite">https://learn.microsoft.com/es-es/sysinternals/downloads/sysinternals-suite</a> y también descargaremos **pestudio** <a href="https://www.winitor.com/download">https://www.winitor.com/download</a>
<br/>
*Tenemos que hacerle una snapshot a esta instalación por si acaso hubiera algún problema.*
<br/>


## 4- Aislar la máquina virtual y crea una snapshot 

Para acabar de terminar de asegurar nuestros laboratorios y que el malware no se escape, vamos a aislar la máquina en otra red.

Lo primero, desactivamos las carpetas compartidas en: (VMware) Settings > Options > Shared Folders y click en Disabled.

Esta máquina deberá estar en una red **Host-Only** que significa que:<br/>
**X** No tendrá acceso a Internet <br/>
**X** No tiene conexión con los demás dispositivos de la red<br/>
**X** No tendrá conexión con el sistema nativo<br/>

En VMware vamos a Edit y seleccionamos "Virtual Network Editor" y creamos una nueva network con esta configuración:<br/>
![Foto VirtualNetworkEditor]({{ 'assets/img/commons/malware-lab/virtual-network-editor.png' | relative_url }}){: width="350" height="350" .normal }
![Foto VirtualNetworkEditor]({{ 'assets/img/commons/malware-lab/dhcp-settings.png' | relative_url }}){: width="350" height="350" .normal }
<br/>
En las propiedades de la lab, en NetworkAdapter le añadimos la red que acabamos de crear
<br/>
![Foto NetworkAdapter]({{ 'assets/img/commons/malware-lab/network-adapter.png' | relative_url }}){: width="350" height="350" .center-image }
<br/>

## 5- Analizar Malwares

En este repositorio tienes disponible algunos malwares disponibles para ver como funcionan:
<br/>
<a href="https://github.com/ytisf/theZoo">Live Malware Repository</a>

Algunas de las herramientas que me gustan para analizar malwares son:<br/>
- PeStudio (análisis estático windows)
- GHidra (desensamblador linux)
- Cutter (desensamblador linux, windows y mac)
- Procmon (monitor de procesos para windows)
- Wireshark (análisis de red)
- INetSim (simulador de servicios de internet)

<br/>
## Aprender más
*Para aprender más sobre Malware Analysis puedes echarle un vistazo a este curso que me sirvió de gran utilidad*<br/>
<a href="https://academy.tcm-sec.com/p/practical-malware-analysis-triage">https://academy.tcm-sec.com/p/practical-malware-analysis-triage</a>